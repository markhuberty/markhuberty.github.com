<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<html lang="en"> 
	<head> 
	  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
	  <title> 
	    Mark Huberty
	  </title> 
	  <meta name="author" content="Mark Huberty"> 
	  <meta name="keywords" content="Mark Huberty, Political
	                                 Science, University of California, Berkeley"> 
	  <meta name="description" content="Mark Huberty is a graduate
                                         student in Political Science at
                                         UC Berkeley"> 
	  <meta name="robots" content="index, follow, noarchive"> 

          <!--CSS data-->
          <!-- General formatting -->
          <link rel="stylesheet" href="/css/blueprint/screen.css" type="text/css" media="screen, projection"> 
          <link rel="stylesheet" href="/css/blueprint/meh-custom.css"
                rel="stylesheet" type="text/css">
          <!-- Syntax highlighting -->
          <link rel="stylesheet" href="/css/syntax.css" type="text/css">
	  <script type="text/javascript">

	    var _gaq = _gaq || [];
	    _gaq.push(['_setAccount', 'UA-38678599-1']);
	    _gaq.push(['_trackPageview']);
	    
	    (function() {
	    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	    })();
	    
	  </script>
          <meta name="viewport" content="width=device-width, minimum-scale=1.0">
</head>

<body>
<!-- Headers --> 
<div class="container"> 
  <div class="column span-24"> 
    <div id="menu_divider"> 
      <h1 class="prepend-top alignLeft"> 
	<a href="/index.html" title="Front Page">Mark Huberty</a>
      </h1> 
    </div><!-- MAIN MENU: Top horizontal menu of the site.  Use class="here" to turn the current page tab on --> 
    <div id="mainMenu"> 
      <ul class="floatLeft"> 
        <li><a href="cv.html" title="CV">Resume</a></li>
        <li> 
	  <a href="/recent.html" title="Posts">Recent</a> 
	</li> 
	<li> 
	  <a href="/publications.html" title="Research">Research</a> 
	</li> 
	<li> 
	  <a href="/teaching.html" title="Courses and other Material">Teaching</a> 
	</li>  
	<li><a
	       href="/resources.html"
	       title="Code">Code</a></li> 
	<li> 
	  <a
	     href="/contact.html"
	     title="Contact information">Contact</a> 
	</li> 
      </ul> 
    </div> 
  </div> 
</div>

<div class="container prepend-top">   

    
    <div id="post">
<p>R&#8217;s <a href='http://cran.r-project.org/web/packages/Matrix/index.html'><code>Matrix</code></a> library provides ready access to sparse matrix operations. But the library has one quirk: multiplication by a non-sparse vector (as for multiplying each row of a <code>N</code> row matrix by a scalar held in a <code>N</code> entry vector) returns a dense Matrix.</p>

<p>Here&#8217;s a neat trick for getting around this specific problem with use of the <a href='http://cran.r-project.org/web/packages/inline/index.html'><code>inline</code></a> package.</p>

<pre><code>library(inline)
rcpp.scale.src &lt;- &quot;
int row_idx;
// note the indexing trick: i is valued on 0:[nrow-1]; so no need
// to manipulate it when it&#39;s a C index the way required if you weree
// doing this in R.
for(int row=0; row &lt; *nrow; row++) {

  row_idx = i[row];
  x[row] = x[row] * scale_vec[row_idx];

}&quot;
rcpp.scale.sig &lt;- signature(i=&quot;integer&quot;, nrow=&quot;integer&quot;, x=&quot;numeric&quot;, scale_vec=&quot;numeric&quot;)
c.scale &lt;- cfunction(sig=rcpp.scale.sig,
                     body=rcpp.scale.src,
                     convention=&quot;.C&quot;
                     )

## Assume I have a sparse matrix, sparse.mat, 
## where I want to multiply every element 
## in each row by the row number
sparse.mat = as(sparse.mat, &quot;dgTMatrix&quot;)
scaling.vector = 1:nrow(sparse.mat)
sparse.mat$x = c.scale(sparse.mat@i, length(sparse.mat@i), sparse.mat@x, scaling.vector)$x</code></pre>

<p>Results are <em>fast</em> (as per the documentation for <code>inline</code>). There&#8217;s also no reason this wouldn&#8217;t work for column-wise multiplication, too, with <code>j</code> instead of <code>i</code> as the index.</p>
</div>

<!-- <div id="related"> -->
<!--   <h2>Related Posts</h2> -->
<!--   <ul class="posts"> -->
<!--      -->
<!--       <li><span>13 Mar 2013</span> &raquo; <a href="/2013/03/13/hubway.html">Where do bikes take us together?</a></li> -->
<!--      -->
<!--       <li><span>07 Mar 2013</span> &raquo; <a href="/2013/03/07/haversine.html">Fast haversine distance in cython</a></li> -->
<!--      -->
<!--       <li><span>26 Feb 2013</span> &raquo; <a href="/2013/02/26/big-data-cudgel.html">Big Data is a Cudgel</a></li> -->
<!--      -->
<!--   </ul> -->
<!-- </div> -->

<!-- MathJax stuff, taken from 
  --https://github.com/cwoebker/.com/blob/master/_layouts/default.html -->
<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
  tex2jax: {
  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
  });
  MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for(i=0; i < all.length; i += 1) {
               all[i].SourceElement().parentNode.className += ' has-jax';
               }
               });
</script>

    

</div>


<!-- <address><a href="http://markhuberty.berkeley.edu/">Mark Huberty &lt;markhuberty@berkeley.edu&gt;</a></address> -->
<!-- <\!-- hhmts start -\-> Last modified: Sat May 22 10:56:24 PDT 2010 <\!-- hhmts end -\-> -->
</body>

</html>
